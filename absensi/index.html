<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi - Brahmantyo Tedywisesa</title>
    <link rel="icon" href="../favicon.png" type="image/x-icon">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    
    <style>
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff; display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; padding: 20px;
        }
        .container {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            width: 100%; max-width: 450px; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
        }
        h2 { text-align: center; margin-bottom: 20px; font-size: 1.5rem; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        label { font-size: 0.85rem; margin-bottom: 5px; display: block; color: #ddd; }
        input, select, textarea {
            width: 100%; padding: 12px; border-radius: 10px; border: none;
            background: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 5px;
            color: #333; /* Warna teks agar kontras */
        }
        textarea { resize: vertical; height: 80px; }
        
        button {
            width: 100%; padding: 15px; border: none; border-radius: 10px;
            background: #4CAF50; color: white; font-weight: bold; cursor: pointer;
            font-size: 1rem; transition: 0.3s; margin-top: 10px;
        }
        button:hover { background: #45a049; transform: scale(1.02); }
        button:disabled { background: #ccc; cursor: not-allowed; }

        .loader { display: none; text-align: center; margin-top: 10px; font-size: 0.8rem; color: #ffeb3b; }
        
        /* Opsi User Lama */
        .user-select-container {
            background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2><i class="fas fa-calendar-check"></i> Form Absensi</h2>

    <div class="user-select-container">
        <label><i class="fas fa-users"></i> Pernah mengisi sebelumnya?</label>
        <select id="existingUser" onchange="fillData()">
            <option value="">-- Saya Anggota Baru --</option>
            <option disabled>Memuat data...</option>
        </select>
    </div>

    <form name="submit-to-google-sheet">
        <div class="form-group">
            <label>Nama</label>
            <input type="text" name="Nama" id="nama" placeholder="Gus Samsudin" required>
        </div>
        
        <div class="form-group" style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>Nickname</label>
                <input type="text" name="Nickname" id="nickname" placeholder="FCN Nickname" required>
            </div>
            <div style="flex: 1;">
                <label>OpenID (PlayerID)</label>
                <input type="text" name="OpenID" id="openid" placeholder="12345678" required>
            </div>
        </div>

        <div class="form-group">
            <label>Nomor WhatsApp</label>
            <input type="number" name="No WA" id="wa" placeholder="081xxxxx" required>
        </div>

        <div class="form-group">
            <label>Domisili (Provinsi)</label>
            <select name="Domisili" id="provinsi" required>
                <option value="">-- Pilih Provinsi --</option>
            </select>
        </div>

        <div class="form-group">
            <label>Keterangan</label>
            <textarea name="Keterangan" placeholder="Hadir / Izin / Sakit / Catatan Lain"></textarea>
        </div>

        <button type="submit" id="btnKirim">Kirim Absen</button>
        <div class="loader" id="loader"><i class="fas fa-spinner fa-spin"></i> Sedang mengirim data...</div>
    </form>
    
    <div style="text-align: center; margin-top: 20px;">
        <a href="/" style="color: #ddd; text-decoration: none; font-size: 0.8rem;">&larr; Kembali ke Home</a>
    </div>
</div>

<script>
    // 1. CONFIG: URL SUDAH BENAR
    const scriptURL = 'https://script.google.com/macros/s/AKfycbw6xMH_uyUxvXjSt0cLBIUlgmjNx8u-xf4QMDoB4PHxZALBgqxpy6xw_pozzDd7M7iXmQ/exec';
    
    const form = document.forms['submit-to-google-sheet'];
    const btnKirim = document.getElementById('btnKirim');
    const loader = document.getElementById('loader');
    const existingUserSelect = document.getElementById('existingUser');

    // 2. DATA PROVINSI INDONESIA
    const provinsiList = [
        "Aceh", "Sumatera Utara", "Sumatera Barat", "Riau", "Jambi", "Sumatera Selatan", "Bengkulu", "Lampung", "Kepulauan Bangka Belitung", "Kepulauan Riau",
        "DKI Jakarta", "Jawa Barat", "Jawa Tengah", "DI Yogyakarta", "Jawa Timur", "Banten",
        "Bali", "Nusa Tenggara Barat", "Nusa Tenggara Timur",
        "Kalimantan Barat", "Kalimantan Tengah", "Kalimantan Selatan", "Kalimantan Timur", "Kalimantan Utara",
        "Sulawesi Utara", "Sulawesi Tengah", "Sulawesi Selatan", "Sulawesi Tenggara", "Gorontalo", "Sulawesi Barat",
        "Maluku", "Maluku Utara", "Papua", "Papua Barat", "Papua Selatan", "Papua Tengah", "Papua Pegunungan", "Papua Barat Daya"
    ];

    const selectProv = document.getElementById('provinsi');
    provinsiList.forEach(prov => {
        let option = document.createElement('option');
        option.value = prov;
        option.text = prov;
        selectProv.appendChild(option);
    });

    // 3. FITUR LOAD USER LAMA (AUTOCOMPLETE)
    let userData = {}; 

    fetch(scriptURL)
        .then(response => response.json())
        .then(users => {
            existingUserSelect.innerHTML = '<option value="">-- Saya Pengguna Baru --</option>';
            
            if (users.length === 0) {
                 let option = document.createElement('option');
                 option.text = "(Belum ada data)";
                 option.disabled = true;
                 existingUserSelect.appendChild(option);
            } else {
                users.forEach(user => {
                    let option = document.createElement('option');
                    option.value = user.openid; 
                    option.text = user.nama + " (" + user.nickname + ")";
                    existingUserSelect.appendChild(option);
                    userData[user.openid] = user;
                });
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
            existingUserSelect.innerHTML = '<option disabled>Gagal memuat data user</option>';
        });

    function fillData() {
        const selectedOpenID = existingUserSelect.value;
        if (selectedOpenID && userData[selectedOpenID]) {
            const data = userData[selectedOpenID];
            document.getElementById('nama').value = data.nama;
            document.getElementById('nickname').value = data.nickname;
            document.getElementById('openid').value = data.openid;
            document.getElementById('wa').value = data.wa;
            document.getElementById('provinsi').value = data.domisili;
        } else {
            form.reset();
        }
    }

    // 4. KIRIM DATA KE GOOGLE SHEETS
    form.addEventListener('submit', e => {
        e.preventDefault();
        btnKirim.disabled = true;
        btnKirim.innerHTML = "Mengirim...";
        loader.style.display = "block";

        fetch(scriptURL, { method: 'POST', body: new FormData(form)})
            .then(response => {
                alert("✅ Absensi Berhasil Dikirim!");
                form.reset();
                existingUserSelect.value = ""; 
                btnKirim.disabled = false;
                btnKirim.innerHTML = "Kirim Absen";
                loader.style.display = "none";
                // location.reload(); // Aktifkan jika ingin langsung refresh
            })
            .catch(error => {
                alert("❌ Gagal mengirim! Cek koneksi internet.");
                console.error('Error!', error.message);
                btnKirim.disabled = false;
                loader.style.display = "none";
            });
    });
</script>

</body>
</html>
